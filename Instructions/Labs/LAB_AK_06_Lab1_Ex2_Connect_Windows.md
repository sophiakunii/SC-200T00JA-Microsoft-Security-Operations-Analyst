# モジュール 6 -ラボ 1 - 演習 2 - データ コネクタを使用して Windows デバイスを Azure Sentinel に接続する

### タスク 1: Azure で Windows 仮想マシンを作成する

このタスクでは、Azure で Windows 仮想マシンを作成します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. Microsoft Edge ブラウザーで Azure portal (https://portal.azure.com) に移動します。

3. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

4. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード** をコピーして貼り付け、「**サインイン**」を選択します。

5. 「**+ リソースの作成**」 を選択します。Azure portal をすでに開いている場合は、上部バーから「*Microsoft Azure*」を選択して、ホームに移動することが必要となる可能性があります。

6. 「**サービスとマーケットプレイスの検索**」 ボックスに、「*Windows 10*」と入力します。 

7. *Microsoft Windows10* の**作成**ドロップダウンを選択します。  次に、「**Windows 10 Enterprise バージョン 20H2**」を選択します。

8. サブスクリプションを選択します。

9. *リソース グループ*に対して、「**新規作成**」を選択して、名前として rg-AZWIN01 を入力し、「**OK**」を選択します。

**注:** これは、追跡目的の新しいリソース グループである必要があります。  

10. 「*仮想マシン名*」に、AZWIN01 を入力します。

11. *リージョン*を領域に適したリージョンに設定します。  適切なリージョンが既定になる可能性があります。

12. Azure で使用できる*ユーザー名*を選択して入力します。

13. 任意の*パスワード*を入力します。 

**ヒント:** テナントパスワードを使用するのが最も簡単な方法です。

14. 「*ライセンス*」の下で、チェックボックスを選択します。

15. 「**確認および作成**」を選択します。

16. 「**作成**」 を選択します。リソースが作成されるのを待ちますこれには数分かかることがあります。

### タスク 2: Azure Windows 仮想マシンを接続する。

このタスクでは、Azure Windows 仮想マシンを Azure Sentinel に接続します。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、「**Azure Sentinel**」を選択します。

2. 先ほど作成した Azure Sentinel ワークスペースを選択します。

3. データ コネクタ タブで、リストから「**Security Events via Legacy Agent**」 (レガシ イベントを介するセキュリティ イベント) コネクタを選択します。

4. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

5. 「**Windows 仮想マシンにエージェントをインストールする**」オプションを選択します。

6. 「**Azure Linux 仮想マシンのエージェントのダウンロードとインストール**」を選択します。

7. 前のタスクで作成したリストから **AZWIN01** 仮想マシンを選択し、「**接続**」を選択します。*接続...* メッセージが消えるまで待ちます。

8. 「x」を選択して、ウィンドウを閉じて、「**仮想マシン**」ビューに戻ります。仮想マシンに "このワークスペース" に対する *Log Analytics 接続*があることがわかります。

### タスク 3: 非 Azure Windows マシンを接続する。

このタスクでは、非 Azure Windows 仮想マシンを Azure Sentinel に接続します。

1. 管理者として WIN2 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. Microsoft Edge ブラウザーを開きます。

3. ブラウザーを開き、以前のラボで使用していた資格情報を使用して、https://portal.azure.com で Azure portral にログインします。

4. Azureポータルの検索バーに 「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

5. Azure Sentinel ワークスペースを選択します。

6. 「**データ コネクタ**」を選択してから、リストから、「**Security Events via Legacy Agent**」 (レガシ イベントを介するセキュリティ イベント) コネクタを選択します。

7. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

8. ストリーミングするイベントの選択領域で、「**すべてのイベント**」を選択し、「**変更の適用**」を選択します。

9. 「**非 Azure Windows マシンにエージェントをインストールする**」を選択します。

10. 「**非 Azure Windows マシンのエージェントのダウンロードとインストール**」を選択します。 

11. **Windows エージェントのダウンロード (64 ビット)** のリンクを選択します。

12. ダウンロード中した *MMASetup-AMD64.exe* ファイルを開き、「**はい**」を選択して、表示されるユーザー アカウント制御ウィンドウで、実行可能ファイルの実行を許可します。

13. ウェルカム ダイアログで「**次へ**」を選択します。

14. マイクロソフト ソフトウェア ライセンス条項ページで「**同意する**」を選択します。  宛先プロンプトで、「**次へ**」を選択します。

15. エージェントのセットアップ オプションプロンプトで、「**エージェントを Azure Log Analytics (OMS) に接続する**」オプションを選択し、「**次へ**」を選択します。

16. Azure Sentinel が開いているブラウザーで、「エージェントの管理」 ページから **ワークスペース ID** をコピーし、ダイアログのワークスペース ID に貼り付けます。 

17. Azure Sentinel が開いているブラウザーで、「エージェントの管理」 ページから**主キー**をコピーし、ダイアログの 「ワークスペース」 キーに貼り付けます。 

18. 「**次へ**」を選択します。

19. MicrosoftUpdateページで「**次へ**」を選択します。

20. 次に、「**インストール**」を選択します。  完了したら、「**完了**」を選択します。

### タスク 4: Sysmonログをインストールして収集します。

このタスクでは、Sysmonログをインストールして収集します。

引き続きWIN2 仮想マシンに接続する必要があります。次の手順では、既定構成でSysmonをインストールします。実稼働マシンで使用する Sysmon のコミュニティベースの構成を調査する必要があります。

1. ブラウザーで新しいタブを開き、https://docs.microsoft.com/sysinternals/downloads/sysmon に移動します

2. 「**Sysmon のダウンロード**」を選択して、ページから Sysmon をダウンロードします。

3. *Sysmon.zip* にカーソルを合わせ、フォルダ－ アイコンを選択します。ダウンロードしたファイルを右クリックして、「**すべて展開...**」を選択し、「**ファイルを下のフォルダーに展開する**」の下で、「*C:\Sysmon*」と入力して、「**展開**」を選択します。 

4. Windows の WIN2 タスクバーの検索ボックスに*コマンド*を入力します。  検索結果には、コマンド プロンプト アプリが表示されます。  コマンド プロンプト アプリを右クリックし、「**管理者として実行**」 を選択します。  「**はい**」を選択して、表示されるユーザー アカウント制御ウィンドウで、アプリの実行を許可します。

5. *cd \sysmon* と入力します

6. *notepad sysmon.xml* と入力して、新しいファイルを作成します。「**はい**」を選択して、ファイルの作成を確認します。

7. ブラウザーで新しいタブを開き、https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml に移動します

8. 「**Raw**」ボタンを選択し、そのファイルの内容を Github から作成した sysmon.xml メモ帳ファイルにコピーします。「**ファイル**」を選択してから、「**保存**」を選択して、ファイルを保存します。

9. コマンド プロンプトで次のように入力し、Enter キーを押します。
    sysmon.exe -accepteula -i sysmon.xml

**注:**  「構成ファイルが検証されました」および「Sysmon が開始されました」というメッセージが出力に表示されることを確認します。そうならない場合は、データが適切にコピーされ、sysmon.xml が保存されていることを確認します。

10. ブラウザで、https：//portal.azure.comのAzureポータルに戻ります 

11. Azure portal の検索バーに、「*Sentinel*」と入力してから、「**Azure Sentinel**」を選択し、以前に作成した Azure Sentinel ワークスペースを作成します。

12. Azure Sentinelで、構成領域から「**設定**」を選択し、「**ワークスペース設定 >**」タブを選択します

13. AzureSentinel ワークスペースが選択されていることを確認してください。

14. 「設定」領域で「**エージェントの構成**」を選択します。

15. 「**Windows イベントログ**」タブを選択します。

16. 「**Windows イベントログの追加**」ボタンを選択します。

17. ログ名フィールドに「**Microsoft-Windows-Sysmon/Operational**」と入力します。

18. 「**適用**」を選択します。

### タスク 5: Microsoft Defender for Endpoint ディバイスをオンボードする。

このタスクでは、デバイスを Microsoft Defender for Endpoint にオンボードします。

**重要:** このコースの最初のモジュールでラボを完了し、仮想マシンを保存した場合は、すでにこのタスクを実行しています。  そのラボ演習と同じ仮想マシンを使用している場合は、このタスクをスキップできます。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. Microsoft Edge ブラウザーで、Microsoft 365 Defender ポータル (https://security.microsoft.com) にアクセスし、現在ポータルにいない場合は、**テナントの電子メール**資格情報を使用してログインします。

3. 左側のメニュー バーから 「**設定**」 を選択し、「設定」 ページから 「**エンドポイント**」 を選択します。

4. デバイス管理セクションで 「**オンボーディング**」を選択します。

5. 「**パッケージのダウンロード**」を選択します。

6. ダウンロードした.zipファイルを解凍します。

7. **管理者**としてWindowsコマンドプロンプトを実行し、表示されるユーザーアカウント制御プロンプトに同意します。

8. 管理者として抽出したばかりの WindowsDefenderATPLocalOnboardingScript.cmd ファイルを実行します。**注** 既定では、ファイルは c：\ users \ admin \ downloads ディレクトリにあります。スクリプトの質問に対して「Y」と回答します。 

9. ポータルの「オンボーディング」ページで、検出テスト スクリプトをコピーしてオープン コマンド ウィンドウで実行します。  新しい**管理者: コマンド プロンプト** ウィンドウを開く必要があるかもしれません。Windows 検索バーで「*CMD*」と入力し、「**管理者として実行**」 を選択します。

10. 「エンドポイント」 領域の Microsoft 365 Defender ポータルで、「**デバイス インベントリ**」 を選択します。お使いになっているデバイスがリストに表示されます。

## 演習 3 に進みます。
